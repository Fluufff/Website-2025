---
import Base from '../layouts/Base.astro'
import Content from '../components/sections/Content.astro'
import Socials from '../content/socials.astro'
import Faq from '../content/Faq.astro'
import FaqItem from '../content/FaqItem.astro'
import Schedule, { type DayInfo, type EventInfo, type OpenLocation, type TagInfo } from '../content/Schedule.vue'

import { type CollectionEntry, getCollection } from 'astro:content'
import { DateTime } from 'luxon'

function shortenTime(time: string): [number, number] {
  const date = DateTime.fromISO(time)
  return [date.hour, date.minute]
}

// Prepare & localize as much as possible on the server-side

const openLocations = await getCollection('scheduleOpenLocations')
const order = ['Bar', 'Fursuit Lounge', 'Photoshoot', "Dealer's Den"]
openLocations.sort((a, b) => order.indexOf(a.data.name) - order.indexOf(b.data.name))

const days = [...new Set(openLocations.flatMap((l) => l.data.opening_times).map((t) => t.day))].sort().map((day) => {
  const date = DateTime.fromISO(day).setLocale('en-US')
  return {
    day,
    name: date.toLocaleString({ weekday: 'long' }),
    short: date.toLocaleString({ day: 'numeric', month: 'short' })
  }
})

const daysParsed: DayInfo[] = days.map(({ name, short }) => ({ name, short }))
const openLocationsParsed: OpenLocation[] = openLocations.map((l) => ({
  name: l.data.name,
  times: l.data.opening_times.map((t) => {
    const dayIndex = days.findIndex((d) => d.day === t.day)
    return [dayIndex, ...shortenTime(t.start_time), ...shortenTime(t.end_time)]
  })
}))

const tags = await getCollection('scheduleTags')
const tagsParsed: TagInfo[] = tags.map((t) => ({ name: t.data.name, emoji: t.data.emoji }))
const locations = await getCollection('scheduleLocations')
const locationsParsed: string[] = locations.map((l) => l.data.name)

const events = await getCollection('scheduleEvents')
const startDate = (e: CollectionEntry<'scheduleEvents'>) =>
  DateTime.fromISO(`${e.data.day}T${e.data.start_time}`).toUnixInteger()
events.sort((a, b) => startDate(a) - startDate(b))

const eventsParsed: EventInfo[] = events.map(({ data, rendered }) => {
  const dayIndex = days.findIndex((d) => d.day === data.day)
  const locationIndex = data.schedule_location
    ? locations.findIndex((l) => l.data.id === data.schedule_location.id)
    : null
  const tagsIndexes = data.schedule_tags.map((t) => tags.findIndex((t2) => t2.data.id === t.id))
  return {
    title: data.title,
    host: data.host_name,
    description: rendered!.html,
    location: locationIndex,
    tags: tagsIndexes,
    time: [dayIndex, ...shortenTime(data.start_time), ...shortenTime(data.end_time)]
  }
})
---

<Base>
  <Content bg="darker" headline="Schedule" wider>
    <Schedule
      openLocations={openLocationsParsed}
      locations={locationsParsed}
      days={daysParsed}
      tags={tagsParsed}
      events={eventsParsed}
      client:load
    />
  </Content>
  <Content headline="Event labels explained">
    <p>Look out for these icons during the convention. They help you find events that match your vibe.</p>
    <dl id="event_labels">
      <dt>ğŸ§  Educational</dt>
      <dd>Hosted by a (semi-)professional or the result of deep research. Focused on informing and teaching.</dd>
      <dt>ğŸ¾ Fursuit-friendly</dt>
      <dd>Includes amenities for fursuiters (fans, water stations) or adjusted pacing/materials.</dd>
      <dt>ğŸ”¨ Workshop</dt>
      <dd>Requires active participation.</dd>
      <dt>ğŸ” NSFW</dt>
      <dd>
        Elements or themes related to fetishes or related topics.<br />
        However, this event is strictly non-sexual so no nudity is shown.
      </dd>
      <dt>ğŸšª Open door event</dt>
      <dd>Can be joined and left at any point during its duration.</dd>
    </dl>
  </Content>
  <Socials />
  <Faq>
    <FaqItem question="Do I need to sign up for events in advance?">
      For most events, no sign-up is needed â€” just show up and enjoy! If an event requires advance registration, this
      will be clearly indicated in the program.
    </FaqItem>
    <FaqItem question="Do I need to be a performer to attend the FlÃ¼Ã¼fff Finale?">
      No, everyone is welcome to enjoy the show.
    </FaqItem>
    <FaqItem question="Will there be things for me to do if I donâ€™t dance or perform?">
      Absolutely! There are panels, workshops, casual meetups, art spaces, and plenty of chill corners to explore and
      enjoy.
    </FaqItem>
  </Faq>
</Base>

<style lang="scss" is:global>
  @use '../styles/charter';
  @use '../styles/text-styles';

  dl#event_labels {
    display: grid;
    grid-template-columns: auto 1fr;
    border-bottom: solid 1px charter.$neutrals400;
    margin-top: 64px;

    dd,
    dt {
      padding: 22px 14px;
      border-top: solid 1px charter.$neutrals400;
    }

    dt {
      color: charter.$neutrals700;
      display: flex;
      align-items: center;
      @include text-styles.heading4;
    }

    dd {
      color: charter.$neutrals600;
      @include text-styles.display3Regular;
    }
  }
</style>
